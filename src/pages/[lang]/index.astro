---
import MainLayout from '../../layouts/MainLayout.astro';
import LabCard from '../../components/LabCard.astro';
import fs from 'node:fs';
import path from 'node:path';
import matter from 'gray-matter';
import { ui } from '../../utils/i18n.js'; // ĞœÑ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ´Ğ¸Ğ¼ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¼ ÑˆĞ°Ğ³Ğ¾Ğ¼

// 1. Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿ÑƒÑ‚Ğ¸ Ğ´Ğ»Ñ Astro
export async function getStaticPaths() {
  return [
    { params: { lang: 'ru' } },
    { params: { lang: 'en' } }
  ];
}

const { lang } = Astro.params;
const t = ui[lang]; // Ğ‘ĞµÑ€ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ²Ğ¾Ğ´Ñ‹

function getLatestFiles(dirPath) {
  const fullPath = path.resolve(dirPath);
  if (!fs.existsSync(fullPath)) return [];
    
  const files = fs.readdirSync(fullPath).filter(f => f.endsWith('.md'));
    
  const dataMap = files.map(file => {
    const fileContent = fs.readFileSync(path.join(fullPath, file), 'utf-8');
    const { data } = matter(fileContent);
    
    // Ğ­Ğ¢Ğ Ğ¡Ğ¢Ğ ĞĞ§ĞšĞ ĞŸĞĞšĞĞ–Ğ•Ğ¢ Ğ’Ğ¡Ğ Ğ’ Ğ¢Ğ•Ğ ĞœĞ˜ĞĞĞ›Ğ•
    console.log(`Ğ¤Ğ°Ğ¹Ğ»: ${file} | Ğ¯Ğ·Ñ‹Ğº: ${lang} | Order: ${data.order}`);

    return {
      slug: file.replace('.md', ''),
      data: data
    };
  });

  return dataMap
    .sort((a, b) => {
      const aOrder = a.data.order !== undefined ? Number(a.data.order) : 999;
      const bOrder = b.data.order !== undefined ? Number(b.data.order) : 999;
      return aOrder - bOrder;
    })
    .slice(0, 3);
}

const latestLabs = getLatestFiles('./src/content/labs', lang);
const latestArticles = getLatestFiles('./src/content/articles', lang);
---

<MainLayout title={t['hero.title']}>
  <section class="hero">
    <h1>{t['hero.title']}</h1>
    <p>{t['hero.desc']}</p>
  </section>

  <section class="home-section">
    <div class="section-header">
      <h2>ğŸ§ª {t['nav.labs']}</h2>
      <a href={`/${lang}/labs`}>{lang === 'ru' ? 'Ğ’ÑĞµ Ğ»Ğ°Ğ±Ñ‹ â†’' : 'All labs â†’'}</a>
    </div>
    <div class="grid">
      {latestLabs.map(lab => (
        <LabCard 
          title={lab.data.title} 
          desc={lab.data.description} 
          image={lab.data.image} 
          date={lab.data.date}  
          url={`/${lang}/labs/${lab.slug}`} 
        />
      ))}
    </div>
  </section>
</MainLayout>