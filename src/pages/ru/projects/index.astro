---
import MainLayout from '../../../layouts/MainLayout.astro';
import fs from 'node:fs';
import path from 'node:path';
import matter from 'gray-matter';

// 1. –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–• (Server-side)
const lang = "ru"; // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–∑—ã–∫
const projectsDir = path.resolve(`./src/content/projects/${lang}`);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–∞–ø–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —è–∑—ã–∫–∞
if (!fs.existsSync(projectsDir)) {
  // –ù–µ —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –ø—É—Å—Ç—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  // –ù–æ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–≤–∏–º –º–∞—Å—Å–∏–≤ –ø—É—Å—Ç—ã–º
}

// –ß–∏—Ç–∞–µ–º –ø–∞–ø–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ /ru/
const projectFolders = fs.existsSync(projectsDir) 
  ? fs.readdirSync(projectsDir).filter(f => 
      fs.statSync(path.join(projectsDir, f)).isDirectory()
    )
  : [];

// –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–µ–∫—Ç–∞—Ö –∏ –∏—Ö –∫–∞—Ä—Ç–æ—á–∫–∞—Ö
const allProjects = projectFolders.map(folder => {
  const folderPath = path.join(projectsDir, folder);
  const files = fs.readdirSync(folderPath).filter(f => f.endsWith('.md'));
  
  const cards = files.map(file => {
    const fileContent = fs.readFileSync(path.join(folderPath, file), 'utf-8');
    const { data } = matter(fileContent);
    
    return { 
      ...data, 
      fileName: file.replace('.md', '') 
    }; 
  });

  return { folder, cards };
});
---

<MainLayout title="–ú–æ–∏ –ü—Ä–æ–µ–∫—Ç—ã">
  <section>
    <header class="page-header">
      <h1>üìÅ –ü—Ä–æ–µ–∫—Ç—ã</h1>
      <p>–ü—Ä–æ–µ–∫—Ç—ã –∏ –∫–µ–π—Å—ã.</p>
    </header>
    
    {allProjects.length === 0 && (
      <div class="empty-state">
        <p>–ü—Ä–æ–µ–∫—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É –≤ <code>src/content/projects/{lang}/–Ω–∞–∑–≤–∞–Ω–∏–µ</code></p>
      </div>
    )}

    {allProjects.map(project => (
      <div class="project-group">
        <div class="project-title">
          <h2>üìÅ {project.folder}</h2>
        </div>
        
        <div class="cards-preview-grid">
          {project.cards.map(card => (
            /* –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º /ru/ –≤ —Å—Å—ã–ª–∫—É */
            <a href={`/${lang}/projects/${project.folder}/${card.fileName}`} class="card-link">
              <div class="mini-card">
                <div class="card-icon">üìù</div>
                <div class="card-body">
                  <h4>{card.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</h4>
                  <p>{card.description || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}</p>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    ))}
  </section>
</MainLayout>

<style>
  /* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–Ω–∏ —É —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω—ã–µ */
  .page-header {
    margin-bottom: 40px;
    border-left: 4px solid var(--accent);
    padding-left: 20px;
  }

  .project-group {
    background: #111111;
    border: 1px solid #222;
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 40px;
    width: 100%;
    box-sizing: border-box;
  }

  .project-title h2 {
    margin: 0 0 25px 0;
    font-size: 1.4rem;
    color: #fff;
    letter-spacing: -0.5px;
  }

  .cards-preview-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
    gap: 20px !important;
    width: 100%;
  }

  .card-link {
    text-decoration: none;
    color: inherit;
    display: flex;
    height: 100%;
  }

  .mini-card {
    background: #1a1a1a;
    border: 1px solid #282828;
    padding: 24px;
    border-radius: 12px;
    display: flex;
    gap: 16px;
    width: 100%;
    transition: all 0.2s ease-in-out;
  }

  .card-link:hover .mini-card {
    background: #222;
    border-color: var(--accent);
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  }

  .card-icon {
    font-size: 1.4rem;
    line-height: 1;
  }

  .mini-card h4 {
    margin: 0 0 8px 0;
    color: var(--accent);
    font-size: 1.05rem;
    font-weight: 600;
  }

  .mini-card p {
    margin: 0;
    color: #888;
    font-size: 0.9rem;
    line-height: 1.5;
  }

  @media (max-width: 600px) {
    .cards-preview-grid {
      grid-template-columns: 1fr !important;
      gap: 15px !important;
    }
    .project-group {
      padding: 20px;
    }
  }
</style>