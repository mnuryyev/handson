---
title: "Nmap: разведка и сканирование
description: "В этой работе мы разберём, как работает Nmap, от обнаружения активных хостов и анализа трафика в Wireshark до практического сканирования портов и сервисов"
image: "/images/arp_spoofing_sec/main.jpg"
date: "21 февраля 2026"
---
**Nmap** — это свободно распространяемый инструмент с открытым исходным кодом, предназначенный для анализа сетевой инфраструктуры и оценки её защищённости. Утилита применяется как при работе с отдельными узлами, так и при исследовании крупных сетевых сегментов.

Инструмент подходит как для проверки одного компьютера, так и для анализа целого диапазона адресов. Он позволяет не только посмотреть открытые порты, определить версии сервисов и попытаться понять, какая операционная система стоит на машине, но и при необходимости запускать дополнительные проверки через встроенные скрипты. Благодаря этим возможностям Nmap часто используют в пентесте, он помогает безопасно проверить сеть на слабые места, увидеть открытые сервисы и определить потенциальные уязвимости, чтобы их потом закрыть или усилить защиту.

## Использование Nmap

![01_nmap](/handson/images/nmap_tools//01_nmap.png)

При запуске Nmap мы сразу указываем, что именно хотим сканировать и с какими параметрами. Всё, что не относится к опциям и ключам программы, Nmap автоматически считает целью. Поэтому можно перечислять несколько адресов подряд, утилита попробует просканировать каждый из них.

В качестве цели можно задать отдельный IP‑адрес, несколько адресов, диапазон, подсеть или целую сеть. Всё зависит от задачи.

Ещё один момент, это права доступа. Многие типы сканирования требуют прав суперпользователя. Без них часть функций работать не будет, либо Nmap переключится на более простой режим. В целом проще сразу запускать через sudo, чтобы не упираться в ограничения во время работы.

## TCP-флаги и их значение для сканирования

Чтобы понять, как именно Nmap определяет состояние портов, нужно немного разобраться с TCP‑флагами. В каждом TCP‑сегменте есть управляющие биты, именно они задают поведение соединения. Nmap активно использует их, отправляя специальные комбинации флагов и анализируя ответ цели. За счёт этого можно определить состояние порта, даже не устанавливая полноценное соединение.

| **Флаг** | **Бит** | **Назначение** | **Роль в Nmap** |
| --- | --- | --- | --- |
| SYN | 0x02 | Запрос на установку соединения | Базовый пробник для SYN-сканирования |
| ACK | 0x10 | Подтверждение получения данных | ACK-сканирование для firewall mapping |
| RST | 0x04 | Сброс соединения | Ответ закрытого порта; Nmap отправляет RST после SYN/ACK |
| FIN | 0x01 | Завершение соединения | FIN/NULL/XMAS scans для обхода stateless firewall |
| PSH | 0x08 | Передать данные приложению немедленно | Компонент XMAS-сканирования |
| URG | 0x20 | Срочные данные (urgent pointer) | Компонент XMAS-сканирования |
| ECE | 0x40 | ECN-Echo (перегрузка сети) | Используется в OS fingerprint пробах |
| CWR | 0x80 | Congestion Window Reduced | Анализируется при OS detection |

На практике чаще всего мы сталкиваемся с SYN, ACK и RST. Именно на них строится базовое понимание открытых и закрытых портов. Остальные флаги используются в более специфичных техниках сканирования или при определении операционной системы.

## Состояния портов в интерпретации Nmap

Если кажется, что порт может быть только открыт или закрыт — это логично, но на практике всё немного сложнее. Из‑за того, как работают разные протоколы и сетевые фильтры, не всегда можно однозначно понять, что происходит на стороне цели. Поэтому Nmap выделяет несколько состояний портов. Понимание этих статусов важно, иначе результаты сканирования можно легко интерпретировать неправильно.

| **Состояние** | **Что происходит в сети** | **Wireshark фильтр** |
| --- | --- | --- |
| open | Цель отвечает SYN/ACK (TCP) или данными (UDP) | tcp.flags.syn==1 && tcp.flags.ack==1 |
| closed | Цель отвечает RST/ACK — порт недоступен, но хост жив | tcp.flags.reset==1 |
| filtered | Пакет дропается; нет ответа или приходит ICMP type 3 | icmp.type==3 |
| unfiltered | ACK-скан: порт доступен, но open/closed неизвестно | tcp.flags.ack==1 |
| open|filtered | UDP или FIN-скан: нет ответа — неизвестно | (нет пакета) |
| closed|filtered | Только IP-IDLE скан: IP ID анализ | ip.id анализ |

Когда мы начинаем работать с новой целью, мы почти ничего о ней не знаем. Наша задача, это собрать первичную информацию. Т.е понять, жив ли хост, какие порты отвечают и как они себя ведут. Уже на этом этапе можно определить дальнейший план действий.

Конечно, универсального алгоритма не существует, всё зависит от задачи. Но есть базовые вещи, которые нужно понимать хорошо: что означают состояния портов, как на них реагирует Nmap и что при этом видно в трафике.

## Обнаружение хостов

Если посмотреть справку Nmap, первым делом там идёт обнаружение хостов. По сути, это проверка, есть ли вообще кто‑то по указанным адресам. Перед тем как сканировать порты, нужно понять, отвечает ли устройство. Обычно это называют пинг‑сканированием. Но это не только обычный ping. Nmap может использовать разные способы проверки: ICMP, TCP, UDP или ARP‑запросы. Это удобно, потому что иногда обычный ping отключён, а другие типы запросов проходят.

Если хост отвечает, Nmap по умолчанию продолжит работу и начнёт сканировать его порты. Если же нужно просто узнать, какие адреса живые, без проверки портов, это можно указать отдельно в параметрах.

## Опции Nmap для обнаружения хостов

### -sL - вывод списка целей

Опция **-sL** используется, когда нужно просто посмотреть список адресов, которые попадают под указанный диапазон. В этом режиме Nmap ничего не сканирует и не отправляет пакеты, он лишь выводит IP‑адреса, входящие в заданную сеть. Если для них настроены DNS‑имена, они тоже будут показаны. В конце отображается общее количество найденных адресов. Если же указать доменное имя, Nmap покажет соответствующий ему IP и попробует выполнить обратное DNS‑разрешение.

### -sn - обнаружение активных хостов

![02_ip](screens/02_ip.png)

![03_sn](screens/03_sn.png)

![04_sn_wireshark](screens/04_sn_wireshark.png)

Опция **-sn** используется для того, чтобы понять, какие устройства в сети вообще отвечают. При этом порты не сканируются, мы просто проверяем, кто живой.

На скриншоте видно, какой адрес выдан машине и к какой подсети он относится. Адрес 10.10.0.105/24, значит мы находимся в сети 10.10.0.0/24.

В моём случае Nmap показал 7 активных устройств в сети. Именно они ответили на проверочные запросы.

Смотрим Wireshark, что происходило в момент сканирования. В локальной сети Nmap обычно использует ARP‑запросы. Так как это сеть **/24**, перебор идёт примерно от **.1** до **.254** (всего 254 возможных хоста). Каждый ARP‑запрос, это попытка узнать, существует ли устройство с таким IP. Если устройство есть, оно отвечает своим MAC‑адресом. В Wireshark это хорошо видно, ARP‑запросы разлетаются по сети, и только реальные хосты отправляют ответы. Именно по этим ответам Nmap и определяет, какие устройства активны.

### -Pn - пропустить обнаружение хостов

![05_windows](screens/05_windows.png)

![06_Pn](screens/06_Pn.png)

![07_Pn_wireshark](screens/07_Pn_wireshark.png)


Опция **-Pn** отключает этап пинг‑сканирования. Это значит, что Nmap не будет проверять, живой ли хост, а сразу перейдёт к сканированию портов. Проще говоря, он считает, что цель активна, даже если она не отвечает на ping. Это полезно в ситуациях, когда ICMP или другие методы обнаружения заблокированы, и обычное определение хоста не срабатывает.

Для теста я добавил в сеть машину с Windows, именно её будем использовать как цель. Сначала смотрим её IP‑адрес. После этого запускаем сканирование уже напрямую по этому IP.

Так как используется **-Pn**, Nmap не пытается сначала определить активность хоста, а сразу начинает проверять порты. На скриншоте видно результат, отображаются открытые порты на Windows‑машине.

В Wireshark при этом можно заметить, что этапа ARP/ICMP‑проверки перед сканированием нет (или он минимален), и сразу идут TCP‑пакеты к конкретным портам. Именно в этом и разница по сравнению с обычным запуском без **-Pn**.

### -PS, -PA, -PU — альтернативные способы обнаружения хоста

Эти опции используются на этапе обнаружения хостов, когда нужно проверить, отвечает ли устройство, но обычный ping может быть заблокирован. Разница между ними в типе отправляемого пакета. -PS отправляет TCP SYN на указанный порт, -PA — TCP ACK, а -PU — UDP‑пакет (для него требуются права root). В случае с UDP цель часто отвечает ICMP‑сообщением "порт недоступен", и по этому ответу Nmap понимает, что хост активен. Если приходит ответ, то хост жив, если полная тишина, скорее всего трафик фильтруется или устройство недоступно.

Дополнительно можно указать, какие ICMP‑запросы использовать: -PE (echo request), -PP (timestamp) и -PM (address mask). На практике такие запросы часто блокируются брандмауэром, поэтому в реальных условиях чаще применяются TCP‑методы (-PS, -PA), которые выглядят более естественно для сети.

### -PO - проверка через IP‑протоколы

![08_PO](screens/08_PO.png)

Опция **-PO** используется для обнаружения хоста с помощью IP‑протоколов. В этом режиме Nmap отправляет пакеты с указанием конкретного номера протокола в заголовке IP и смотрит, как цель отреагирует. Если в ответ приходит пакет по тому же протоколу, значит он поддерживается и хост активен. Если же возвращается сообщение о недостижимости, например, ICMP с ошибкой, это говорит о том, что такой протокол на цели не используется или блокируется.

Проще говоря, **-PO** позволяет проверить, какие IP‑протоколы вообще живы на стороне хоста, не переходя к обычному сканированию портов.

### -PR - ARP‑пинг

![09_PR](screens/09_PR.png)

Опция **-PR** включает ARP‑пингование и используется для обнаружения активных хостов в локальной сети (требуются права root). В этом режиме Nmap отправляет ARP‑запросы и ждёт ответов с MAC‑адресом. Если устройство отвечает, значит оно активно.

В пределах одной подсети это один из самых надёжных и быстрых способов определить живые хосты, потому что ARP почти никогда не блокируется. **-PR** отвечает именно за обнаружение устройств. Сканирование служб и портов начинается уже после этого этапа, если дополнительно не отключено другими параметрами.

### --traceroute - трассировка маршрута

![10_traceroute](screens/10_traceroute.png)

Опция **--traceroute** позволяет определить путь до цели, то есть посмотреть, через какие узлы проходит трафик от вашей машины до указанного хоста (в нашем случае scanme.nmap.org). Проще говоря, это встроенная трассировка маршрута внутри Nmap.

Используется она вместе с любым типом сканирования. Nmap сначала выполняет основной скан, а затем на основе полученных данных строит маршрут до цели. Для его работы требуются права root.

* * *

##  Приёмы сканирования

### -sS - TCP SYN‑сканирование

![11_sS](screens/11_sS.png)

**-sS** - это самый популярный тип сканирования в Nmap. Его часто называют полуоткрытым (half‑open), потому что соединение не доводится до конца. Nmap отправляет SYN‑пакет, как будто собирается установить обычное TCP‑соединение, и дальше смотрит на реакцию цели.

Если приходит **SYN/ACK** - порт считается открытым.
Если приходит **RST** - порт закрыт.
Если ответа нет или возвращается ICMP‑ошибка - порт, скорее всего, фильтруется.

Когда Nmap получает **SYN/ACK**, он не отправляет финальный **ACK**, а сразу шлёт **RST**, тем самым обрывая соединение. Поэтому полноценная сессия не создаётся.

![12_port_445](screens/12_port_445.png)

Для открытого 445 порта последовательность выглядела так. Сначала мой хост отправляет **SYN**. Windows отвечает **SYN/ACK**, это значит, что порт открыт и готов принять соединение. После этого Nmap отправляет **RST** и сразу закрывает попытку подключения. Именно поэтому этот тип сканирования считается менее заметным, соединение не доходит до стадии передачи данных.

![13_port_22](screens/13_port_22.png)

Дальше я проверил 22 порт. В этом случае его блокировал брандмауэр. Ни **SYN/ACK**, ни **RST** не приходило. Это означает, что пакет просто отбрасывается. В таком случае Nmap помечает порт как **filtered**, потому что невозможно точно определить, открыт он или закрыт, фильтрация мешает получить ответ.

### -sU - UDP‑сканирование

![14_sU](screens/14_sU.png)

Опция **-sU** используется для проверки портов, на которых работают UDP‑службы. Её можно запускать отдельно или вместе с TCP‑сканированием, например, **-sS -sU**, если нужно проверить и TCP, и UDP одновременно.

Работает это так. Nmap отправляет UDP‑пакет на выбранный порт и смотрит на реакцию. Если в ответ приходит ICMP‑сообщение "порт недостижим", значит порт закрыт. Если приходит другой тип ICMP‑ошибки или ответа нет совсем, порт может быть фильтруемым. Если же хост отвечает UDP‑пакетом, значит порт открыт.

Часто при отсутствии ответа Nmap присваивает статус **open|filtered**, потому что невозможно точно понять, открыт порт или пакеты просто отбрасываются. В таких случаях можно попробовать уточнить результат с помощью определения версии сервиса (-sV).

UDP‑сканирование работает заметно медленнее TCP. Это связано с ожиданием ответов и таймаутами. Поэтому на практике обычно указывают конкретные интересующие порты, например, **-p U:53**, чтобы не проверять всё подряд и сократить время сканирования.

### -sA - TCP ACK‑сканирование

![15_sA](screens/15_sA.png)

Опция **-sA** используется не для поиска открытых портов, а для анализа правил брандмауэра. В этом режиме Nmap отправляет TCP‑пакеты с флагом ACK и смотрит, как на них реагирует цель.

Если в ответ приходит **RST**, значит порт доступен (не фильтруется), но открыт он или закрыт, сказать нельзя. В этом случае Nmap помечает его как **unfiltered**.

Если ответа нет или приходит ICMP‑ошибка, порт считается **filtered**, то есть трафик блокируется брандмауэром.

### -sO - сканирование IP‑протоколов

![16_sO](screens/16_sO.png)

Опция **-sO** используется для проверки того, какие IP‑протоколы поддерживает целевой хост. В этом случае Nmap работает не с портами, а с номерами протоколов в IP‑заголовке (TCP, UDP, GRE и другие).

Работает это так. Nmap отправляет пакет с указанным номером протокола и смотрит на реакцию. Если приходит какой‑либо ответ, такой протокол считается доступным и помечается как **open**. Если в ответ возвращается ICMP‑сообщение "protocol unreachable", значит протокол не поддерживается, и он отмечается как **closed**.

Если ответа нет вообще, Nmap обычно присваивает статус **open|filtered**, потому что невозможно точно понять, протокол поддерживается, но молчит, или его просто блокирует фильтр.

* * *

## Определение портов и порядка сканирования
 
### -p - выбор конкретных портов

![17_p](screens/17_p.png)

Если нужно сканировать не всё подряд, а только определённые порты, используется параметр **-p**. С его помощью можно указать один порт, несколько через запятую или целый диапазон.

Сначала задаётся тип сканирования (например, -sS или -sU), а затем через **-p** перечисляются нужные порты. Можно также уточнить протокол:
T: — для TCP
U: — для UDP

Если протокол не указан, по умолчанию используются TCP‑порты.

Cамо по себе указание **U**, не включает UDP‑сканирование. Для этого обязательно должна быть добавлена опция **-sU**. Аналогично, для TCP используется **-sS** (или другой TCP‑метод).

Помимо ручного указания портов через **-p**, есть ещё пару быстрых вариантов. Если использовать параметр **-F**, Nmap просканирует только 100 самых распространённых портов. А вот параметр **-p-** означает проверку всех 65535 TCP‑портов. Такой вариант занимает больше времени, но позволяет увидеть всё без исключений, особенно если сервис работает на нестандартном порту.

* * *

## Определение служб, их версий и операционной системы

### -sV - определение версии службы

![18_sV](screens/18_sV.png)

Опция **-sV** отвечает за определение версии сервиса. После того как Nmap находит открытый порт, он начинает отправлять на него специальные запросы, чтобы понять, какая именно служба там работает и, по возможности, определить её версию.

Для этого используется база данных **nmap-service-probes**, которая входит в состав Nmap (она находится в его каталоге установки). В этой базе содержатся шаблоны запросов и варианты ожидаемых ответов. Nmap сравнивает полученный отклик с этими шаблонами и на основе совпадений делает вывод о типе сервиса и его версии.

### -O

![19_O](screens/19_O.png)

Опция **-O** включает режим определения операционной системы цели. Когда она используется, Nmap отправляет на хост набор специально подготовленных TCP и UDP пакетов и анализирует ответы.

Дальше полученные данные сравниваются с записями из базы **nmap-os-db**, которая входит в состав Nmap. В этой базе собраны отпечатки разных операционных систем, то есть характерные особенности их сетевого поведения. Если находится совпадение, Nmap выводит предполагаемую ОС и, иногда, её версию.

Кроме самой системы, утилита может попробовать определить тип устройства (например, сервер, маршрутизатор, принтер) и даже производителя.

Для корректной работы **-O** обычно нужны права root и хотя бы один открытый и один закрытый порт, так точность определения будет выше.

* * *

### -T - шаблоны скорости сканирования (0–5)

![20_T4](screens/20_T4.png)

Параметр **-T** задаёт агрессивность и скорость работы Nmap. По сути, это готовые профили таймингов, сколько ждать ответа, как быстро отправлять пакеты, сколько делать повторов и т.д.

Значения идут от 0 до 5:

**-T0 - paranoid**
Очень медленный режим. Пакеты отправляются с большими паузами.
Используется, если нужно быть максимально незаметным. На практике применяется редко — сканирование может идти очень долго.

**-T1 - sneaky**
Тоже медленный режим, но чуть быстрее предыдущего.
Подходит, если хочется снизить вероятность обнаружения, но не ждать вечность.

**-T2 - polite**
«Вежливый» режим. Уменьшает нагрузку на сеть и целевой хост.
Подходит для аккуратного сканирования чужой инфраструктуры по договорённости, чтобы не создавать лишнюю нагрузку.

**-T3 - normal**
Режим по умолчанию.
Баланс между скоростью и стабильностью. В большинстве случаев его достаточно.

**-T4 - aggressive**
Ускоренное сканирование. Уменьшаются таймауты, быстрее отправляются пакеты.
Часто используется в локальной сети или в лаборатории, где нет строгих ограничений.

**-T5 - insane**
Максимально быстрый режим.
Подходит для очень быстрых и стабильных сетей. В реальных условиях может давать пропуски портов из‑за слишком агрессивных таймингов.

### -A - агрессивное сканирование

![21_A](screens/21_A.png)

Опция **-A** включает сразу несколько продвинутых возможностей Nmap одной командой. По сути, это комбо‑режим, который запускает расширенное исследование цели.

При использовании **-A** автоматически включаются:

- -sV — определение версий сервисов
- -O — попытка определить операционную систему
- --traceroute — трассировка маршрута до хоста

То есть вместо того чтобы писать всё по отдельности, можно просто указать **-A**.

Такой режим даёт максимум информации о цели. Какие службы запущены, их версии, предполагаемая ОС, дополнительные данные из скриптов и путь до хоста.

Но нужно понимать, что **-A**, работает дольше обычного сканирования, создаёт больше сетевого шума, требует прав root для полноценной работы.

Поэтому в лаборатории, отличный вариант. А вот при осторожном пентесте его используют осознанно, потому что он довольно заметный.
